<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<title>linux搭建svn服务器</title>
<link rel="stylesheet" type="text/css" href="css/style.css" />
<link rel="stylesheet" type="text/css" href="http://wangheng.org/tools/bootstrap/css/bootstrap.min.css" media="all" />
<link rel="stylesheet" type="text/css" href="http://wangheng.org/tools/bootstrap/css/bootstrap-responsive.min.css" media="all" />

<script type="text/javascript" src="http://wangheng.org/tools/js/jquery.min.js"></script>	
<script type="text/javascript" src="http://wangheng.org/tools/bootstrap/js/bootstrap.min.js"></script>	
</head>

<!--<body  onresize="resize()" onorientationchange="resize()" >-->
<body >

<!--<canvas id="star_wangheng" style="background-color:#000000">-->
<!--</canvas>-->

<header id="header">
	<div id="navbar-header" class="navbar navbar-static">
              <div class="navbar-inner" style="">
                <div class="container" style="width: auto;">
                  <a class="brand" href="#">我的笔记</a>
                  <a class="brand" href="http://wangheng.org" target="_blank">》博客 </a>
                  <ul class="nav" role="navigation">
                    <li class="dropdown">
                      <a id="drop1" href="#" role="button" class="dropdown-toggle" data-toggle="dropdown">Windows相关 <b class="caret"></b></a>
                      <ul class="dropdown-menu" role="menu" aria-labelledby="drop1">
                        <li><a tabindex="-1" href="windows_modify_route.html">windows修改默认路由</a></li>
                        <li><a tabindex="-1" href="windows_del_svn_folder.html">windows右键清除svn目录</a></li>
                        <li><a tabindex="-1" href="#">...</a></li>
                        <li class="divider"></li>
                        <li><a tabindex="-1" href="windows.html">全部windows笔记</a></li>
                      </ul>
                    </li>
                    <li class="dropdown">
                      <a href="#" id="drop2" role="button" class="dropdown-toggle" data-toggle="dropdown">Linux相关<b class="caret"></b></a>
                      <ul class="dropdown-menu" role="menu" aria-labelledby="drop2">
                        <li><a tabindex="-1" href="linux_basic_command.html">基本命令</a></li>
                        <li><a tabindex="-1" href="Linux_network_setting.html">Linux下的网络设置</a></li>
                        <li><a tabindex="-1" href="create_linux_start_script.html">创建Linux开机启动脚本</a></li>
                        <li class="divider"></li>
                        <li><a tabindex="-1" href="linux.html">查看全部</a></li>
                      </ul>
                    </li>
                  </ul>
                  <ul class="nav pull-right">
                    <li id="fat-menu" class="dropdown">
                      <a href="#" id="drop3" role="button" class="dropdown-toggle" data-toggle="dropdown">功能<b class="caret"></b></a>
                      <ul class="dropdown-menu" role="menu" aria-labelledby="drop3">
                        <li><a tabindex="-1" href="#leave_comments">留言</a></li>
                        <!-- <li><a tabindex="-1" href="#">Another action</a></li>
                        <li><a tabindex="-1" href="#">Something else here</a></li> -->
                        <li class="divider"></li>
                        <li><a tabindex="-1" href="mailto:me@wangheng.org">联系我</a></li>
                      </ul>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
<!-- <div id="logo" style="font-size: 22pt;text-align:center;"><a href="http://wangheng.org/html/index.html">王恒的笔记</a></div>
 -->
</header>
<div id="wrap">
<div id="content">	

<hr />
<ul>
<li>
HTTP:// [apache]

</ul>
<p>
1.安装包 [已安装subversion]
$ sudo apt-get install libapache2-svn
创建版本仓库：
sudo svnadmin create /目录地址
目录地址必须存在，这个就是保存版本仓库的地方，不同的版本仓库创建不同的文件夹即可，比如：
sudo svnadmin create /home/svn/project
本来/home/svn/project这个目录下什么都没有，执行下面的命令之后再去看一下，多出一些文件和文件夹，我们需要操作的是conf这个文件夹，这个文件夹下有一个文件，叫做passwd，用来存放用户名和密码。
然后把这个版本仓库目录授权给apache读写：
sudo chown -R www-data:www-data /目录地址
然后来到打开apache配置文件：
sudo gedit /etc/apache2/mods-available/dav_svn.conf
加入如下内容：
&lt;Location /project&gt;
DAV svn
SVNPath /home/svn/project
AuthType Basic
AuthName “myproject subversion repository”
AuthUserFile /home/svn/project/conf/passwd
#&lt;LimitExcept GET PROPFIND OPTIONS REPORT&gt;
Require valid-user
#&lt;/LimitExcept&gt;
&lt;/Location&gt;
location说的是访问地址，比如上述地址，访问的时候就是
<a href="http://127.0.0.1/project">http://127.0.0.1/project</a>
其中有两行被注释掉了，以保证每次都需要用户名密码。
最后一步就是创建访问用户了，建议将用户名密码文件存放在当前版本仓库下conf文件夹下，这样版本仓库多的时候无至于太乱。
因为conf文件夹下已经存在passwd文件了，所以直接添加用户：
sudo htpasswd -c /home/svn/project/conf/passwd test
然后输入两遍密码，laoyang这个用户就创建好了。
打开/home/svn/project/conf/passwd这个文件，会开到形如如下形式的文本：
test:WEd.83H.gealA //后面是加密后的密码。
创建以后，再次需要往别的版本仓库添加这个用户，直接把这一行复制过去就可以了。
重启apache就可以了。
sudo /etc/init.d/apache2 restart
<hr />
三、同步更新 [勾子]
同步程序思路：用户提交程序到SVN，SVN触发hooks,按不同的hooks进行处理，这里用到的是post-commit，利用post-commit到代码检出到SVN服务器的本地硬盘目录，再通过rsync同步到远程的WEB服务器上。 
</p>

<p>
知识点：
1、SVN的hooks
</p>
<ol>
<li>
start-commit 提交前触发事务

<li>
pre-commit 提交完成前触发事务

<li>
post-commit 提交完成时触发事务

<li>
pre-revprop-change 版本属性修改前触发事务

<li>
post-revprop-change 版本属性修改后触发事务

</ol>
<p>
通过上面这些名称编写的脚本就就可以实现多种功能了，相当强大。
2、同步命令rsync的具体参数使用
3、具有基个语言的编程能力bash python perl都可以实现 
</p>

<p>
post-commit具体实现细节
post-commit脚本 
</p>

<p>
编辑文件：sudo vim /home/svn/fitness/hooks/post-commit 
</p>

<p>
注意：编辑完成post-commit后，执行：sudo chmod 755 post-commit 
</p>

<p>
内容： 
</p>

<p>
#!/bin/sh
export LANG=zh_CN.UTF-8
sudo /usr/bin/svn update /var/www/www --username mirze --password 123456 
</p>

<p>
或 
</p>

<p>
#Set variable
SVN=/usr/bin/svn
WEB=/home/test_nokia/
RSYNC=/usr/bin/rsync
LOG=/tmp/rsync_test_nokia.log
WEBIP="192.168.0.23"
export LANG=en_US.UTF-8
#update the code from the SVN
\(SVN update \)WEB --username user --password password
#If the previous command completed successfully, to continue the following
if [ $? == 0 ]
then
echo "" &gt;&gt; $LOG
echo <code>date</code> &gt;&gt; $LOG
echo "##############################" &gt;&gt; $LOG
chown -R nobody:nobody /home/test_nokia/
#Synchronization code from the SVN server to the WEB server, notes:by the key
\(RSYNC -vaztpH --timeout=90 --exclude-from=/home/svn/exclude.list \)WEB root@\(WEBIP:/www/ &gt;&gt; \)LOG
fi
以上是具体的post-commit程序
注意事项：
1、一定要定义变量，主要是用过的命令的路径。因为SVN的考虑的安全问题，没有调用系统变量，如果手动执行是没有问题，但SVN自动执行就会无法执行了。
2、SVN update 之前一定要先手动checkout一份出来，还有这里一定要添加用户和密码如果只是手动一样会更新，但自动一样的不行。
3、加上了对前一个命令的判断，如果update的时候出了问题，程序没有退出的话还会继续同步代码到WEB服务器上，这样会造成代码有问题
4、记得要设置所属用户，因为rsync可以同步文件属性，而且我们的WEB服务器一般都不是root用户，用户不正确会造成WEB程序无法正常工作。
5、建议最好记录日志，出错的时候可以很快的排错
6、最后最关键的数据同步，rsync的相关参数一定要清楚，这个就不说了。注意几个场景：
这里的环境是SVN服务器与WEB服务器是开的
把SVN服务器定义为源服务器 WEB服务器为目的服务器
场景一、如果目的WEB服务器为综合的混杂的，像只有一个WEB静态资源，用户提交的，自动生成的都在WEB的一个目录下，建议不要用–delete这个参数
上面这个程序就是这样，实现的是源服务器到目的服务器的更新和添加，而没有删除操作，WEB服务器的内容会多于源SVN的服务器的
场景二、实现镜像，即目的WEB服务器与源SVN服务器一样的数据，SVN上任何变化WEB上一样的变化，就需要–delete参数
场景三、不需要同步某些子目录，可能有些目录是缓存的临时垃圾目录，或者是专用的图片目录（而不是样式或者排版的）要用exclude这个参数
注意：这个参数的使用不用写绝对路径，只要目录名称就行 aa代表文件 aa/ 代表目录 ，缺点就是如果有多个子目录都是一样的名称那么这些名称就都不会被同步
建议用–exclude-from=/home/svn/exclude.list 用文件的形式可以方便的添加和删除
exclude.list
.svn/
.DS_Store
images/
利用SVN的钩子还可以写出很多的程序来控制SVN 如代码提交前查看是否有写日志，是否有tab，有将换成空格，是否有不允许上传的文件，是否有超过限制大小的文件等等。
</p>

</div>

<h2 style="font-size: 18pt">给我留言</h2>

<!-- Duoshuo-->
<div class="ds-thread" data-thread-key=""	data-title="" data-author-key="" data-url=""></div>
</div>

<br />
<!--this is my footer-->
<div id="footer">

<a href="#" rel="alternate" type="application/rss+xml"><img alt="RSS" src="img/rss_button.gif" width="16" height="16" style="border:none" /></a>

<a href="http://wangheng.org" target="_blank"><img border="0" src="img/me.png" alt="By WangHeng" height="48" width="48"></a>

<a href="http://www.vim.org" target="_blank"><img border="0" src="img/created_with_vim.png" alt="Created with Vim" height="36" width="90"></a>

<img alt="知识共享许可协议" height="31" width="80" style="border-width:0" src="img/cc_80x31.png" /> 本作品采用知识共享署名-非商业性使用-禁止演绎 3.0 Unported <a name="license" rel="license" href="http://creativecommons.org/licenses/by-nc-nd/3.0/">许可协议</a>进行许可。


</div>


<!--For my star background-->
<!--<script type="text/javascript" src="js/starfield.js"></script>-->
<!--<script type="text/javascript">-->
	<!--start()-->
<!--</script>-->

<!--For code syntax-->
<script type="text/javascript" src="js/shCore.js"></script>
<script type="text/javascript" src="js/shBrushBash.js"></script>
<script type="text/javascript" src="js/shBrushCpp.js"></script>
<script type="text/javascript" src="js/shBrushCSharp.js"></script>
<script type="text/javascript" src="js/shBrushCss.js"></script>
<script type="text/javascript" src="js/shBrushJava.js"></script>
<script type="text/javascript" src="js/shBrushJScript.js"></script>
<script type="text/javascript" src="js/shBrushPhp.js"></script>
<script type="text/javascript" src="js/shBrushPython.js"></script>
<script type="text/javascript" src="js/shBrushSql.js"></script>
<script type="text/javascript" src="js/shBrushXml.js"></script>

<link type="text/css" rel="stylesheet" href="css/shCore.css"/>
<link type="text/css" rel="stylesheet" href="css/shCoreMidnight.css"/>
<script type="text/javascript">
SyntaxHighlighter.all();
</script>
<!--加载js-->
<script type="text/javascript" src="js/tools.js"></script>
</body>
</html>

