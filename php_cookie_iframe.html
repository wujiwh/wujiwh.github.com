<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<title>cookies 跨域问题</title>
<link rel="stylesheet" type="text/css" href="css/style.css" />
<link rel="stylesheet" type="text/css" href="http://wangheng.org/tools/bootstrap/css/bootstrap.min.css" media="all" />
<link rel="stylesheet" type="text/css" href="http://wangheng.org/tools/bootstrap/css/bootstrap-responsive.min.css" media="all" />

<script type="text/javascript" src="http://wangheng.org/tools/js/jquery.min.js"></script>	
<script type="text/javascript" src="http://wangheng.org/tools/bootstrap/js/bootstrap.min.js"></script>	
</head>

<!--<body  onresize="resize()" onorientationchange="resize()" >-->
<body >

<!--<canvas id="star_wangheng" style="background-color:#000000">-->
<!--</canvas>-->

<header id="header">
	<div id="navbar-header" class="navbar navbar-static">
              <div class="navbar-inner" style="">
                <div class="container" style="width: auto;">
                  <a class="brand" href="#">我的笔记</a>
                  <a class="brand" href="http://wangheng.org" target="_blank">》博客 </a>
                  <ul class="nav" role="navigation">
                    <li class="dropdown">
                      <a id="drop1" href="#" role="button" class="dropdown-toggle" data-toggle="dropdown">Windows相关 <b class="caret"></b></a>
                      <ul class="dropdown-menu" role="menu" aria-labelledby="drop1">
                        <li><a tabindex="-1" href="windows_modify_route.html">windows修改默认路由</a></li>
                        <li><a tabindex="-1" href="windows_del_svn_folder.html">windows右键清除svn目录</a></li>
                        <li><a tabindex="-1" href="#">...</a></li>
                        <li class="divider"></li>
                        <li><a tabindex="-1" href="windows.html">全部windows笔记</a></li>
                      </ul>
                    </li>
                    <li class="dropdown">
                      <a href="#" id="drop2" role="button" class="dropdown-toggle" data-toggle="dropdown">Linux相关<b class="caret"></b></a>
                      <ul class="dropdown-menu" role="menu" aria-labelledby="drop2">
                        <li><a tabindex="-1" href="linux_basic_command.html">基本命令</a></li>
                        <li><a tabindex="-1" href="Linux_network_setting.html">Linux下的网络设置</a></li>
                        <li><a tabindex="-1" href="create_linux_start_script.html">创建Linux开机启动脚本</a></li>
                        <li class="divider"></li>
                        <li><a tabindex="-1" href="linux.html">查看全部</a></li>
                      </ul>
                    </li>
                  </ul>
                  <ul class="nav pull-right">
                    <li id="fat-menu" class="dropdown">
                      <a href="#" id="drop3" role="button" class="dropdown-toggle" data-toggle="dropdown">功能<b class="caret"></b></a>
                      <ul class="dropdown-menu" role="menu" aria-labelledby="drop3">
                        <li><a tabindex="-1" href="#leave_comments">留言</a></li>
                        <!-- <li><a tabindex="-1" href="#">Another action</a></li>
                        <li><a tabindex="-1" href="#">Something else here</a></li> -->
                        <li class="divider"></li>
                        <li><a tabindex="-1" href="mailto:me@wangheng.org">联系我</a></li>
                      </ul>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
<!-- <div id="logo" style="font-size: 22pt;text-align:center;"><a href="http://wangheng.org/html/index.html">王恒的笔记</a></div>
 -->
</header>
<div id="wrap">
<div id="content">	


<h1 id="toc_1">cookies 跨域问题</h1>

<p>
在整合几个应用时,遇到了iframe无法获取cookie(session)的问题，经过google，终于把这个问题解决了，现在记录一下。
</p>

<p>
到整合上线时,发现这个流程走不通，百思不得其解，想了半天也不知道 怎么 回事，google了半天，才发现原来是ie在捣鬼，IE不允许跨域访问cookie(好象firefox没问题，ie自6.0以后改用w3c组织的P3P协议了)，再看看我的应用，在第二步设的cookie，在第三步以后所有Ｂ应用的访问请求，ie都把B应用的cookie blocked掉了（因为用户的访问是从A应用发起，从A应用访问B应用的东东，算跨域访问，IE认为有安全问题）。。。。（IE状态栏有一个红眼睛的button,点开可以看到哪些cookie给blocked掉了）
</p>

<p>
知道原因就好办了,再google知道可以用P3P header可以解决问题！ 直接往响应里加一个P3P的<code>header response().addHeader("P3P", "CP=\"IDC DSP COR CURa ADMa OUR IND PHY ONL COM STA\"");</code>
</p>


<p>
具体请看这里.
</p>

<p>
下面是摘抄的一段Compact Policies的具体取值范围和设值含义。
<code>Compact policies are essentially summaries of P3P policies. They can be used by user agents to quickly get approximate information about P3P policies, therefore improving performance.</code>
</p>

<p>
A网站提供一个页面供其它网站进行Iframe调用,该页面使用了SESSION，并进行了SESSION判断。
</p>

<p>
现象：
</p>

<p>
B网站IFRAME了A网站的页面,总显示SESSION过期，但直接在浏览器中打开该页面却又是正常的。
</p>

<p>
这是由于浏览器的安全性所致,SESSION依赖于COOKIE，A与B是二个完全不同的域，A网站没法去读取B网站下的COOKIE，所以 SESSION也就失效了。
</p>

<p>
解决办法：
</p>

<p>
A网站的页面在输出头上附加一个P3P属性,值为CP=CAO PSA OUR即可。
如：
</p>

<pre class="brush: html">
Response.AddHeader("P3P", "CP=CAO PSA OUR");  

if (Session[SESSIONKEY] == null)  

{  
   //TODO:其它操作  
}
</pre>

<p>
在IE中,页面通过FRAME，JS，IMG等引用其他域名页面的时候，P3P协议会阻止引用也的cookie。
</p>

<p>
举例说明：
在 B.COM中,
</p>

<pre class="brush: html">
&lt;iframe   width = 300   height = 300   src = ""http://www.a.com/test.php""   mce_src = ""http://www.a.com/test.php""   &gt;    view plaincopy to clipboardprint?
&lt;iframe width=300 height=300  
src=""http://www.a.com/test.php"" mce_src=""http://www.a.com/test.php""  
&gt;
&lt;iframe width=300 height=300
src=""http://www.a.com/test.php"" mce_src=""http://www.a.com/test.php""
&gt;
</pre>
<p>
此时,test.php中产生的cookie将会被阻止，而不会记录下来
</p>

<p>
这种情况下,我们引入P3P header ，情况就改变喽~
</p>

<p>
P3P header允许跨域访问隐私数据,从而可以跨域set-cookie成功
</p>

<p>
在 www.a.com/test.php中这样写：
</p>

<p>
<code>header('P3P: CP="CURa ADMa DEVa PSAo PSDo OUR BUS UNI PUR INT DEM STA PRE COM NAV OTC NOI DSP COR"');  </code>
</p>

<p>
cookie就可以跨域了~
</p>

</div>

<h2 style="font-size: 18pt">给我留言</h2>

<!-- Duoshuo-->
<div class="ds-thread" data-thread-key=""	data-title="" data-author-key="" data-url=""></div>
</div>

<br />
<!--this is my footer-->
<div id="footer">

<a href="#" rel="alternate" type="application/rss+xml"><img alt="RSS" src="img/rss_button.gif" width="16" height="16" style="border:none" /></a>

<a href="http://wangheng.org" target="_blank"><img border="0" src="img/me.png" alt="By WangHeng" height="48" width="48"></a>

<a href="http://www.vim.org" target="_blank"><img border="0" src="img/created_with_vim.png" alt="Created with Vim" height="36" width="90"></a>

<img alt="知识共享许可协议" height="31" width="80" style="border-width:0" src="img/cc_80x31.png" /> 本作品采用知识共享署名-非商业性使用-禁止演绎 3.0 Unported <a name="license" rel="license" href="http://creativecommons.org/licenses/by-nc-nd/3.0/">许可协议</a>进行许可。


</div>


<!--For my star background-->
<!--<script type="text/javascript" src="js/starfield.js"></script>-->
<!--<script type="text/javascript">-->
	<!--start()-->
<!--</script>-->

<!--For code syntax-->
<script type="text/javascript" src="js/shCore.js"></script>
<script type="text/javascript" src="js/shBrushBash.js"></script>
<script type="text/javascript" src="js/shBrushCpp.js"></script>
<script type="text/javascript" src="js/shBrushCSharp.js"></script>
<script type="text/javascript" src="js/shBrushCss.js"></script>
<script type="text/javascript" src="js/shBrushJava.js"></script>
<script type="text/javascript" src="js/shBrushJScript.js"></script>
<script type="text/javascript" src="js/shBrushPhp.js"></script>
<script type="text/javascript" src="js/shBrushPython.js"></script>
<script type="text/javascript" src="js/shBrushSql.js"></script>
<script type="text/javascript" src="js/shBrushXml.js"></script>

<link type="text/css" rel="stylesheet" href="css/shCore.css"/>
<link type="text/css" rel="stylesheet" href="css/shCoreMidnight.css"/>
<script type="text/javascript">
SyntaxHighlighter.all();
</script>
<!--加载js-->
<script type="text/javascript" src="js/tools.js"></script>
</body>
</html>

